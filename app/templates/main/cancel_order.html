{% extends "layout/customer_base.html" %}

{% block title %}Cancel Order #{{ order.id }}{% endblock %}

{% block content %}

<div class="container mt-4">

  <!-- PAGE HEADER -->
  <div class="mb-4">
    <h3 class="text-danger">
      ‚ùå Cancel Order #{{ order.id }}
    </h3>
    <p class="text-muted mb-0">
      Please review the details before cancelling your order.
    </p>
  </div>

  <div class="row">

    <!-- LEFT: ORDER SUMMARY (UNCHANGED) -->
    <div class="col-md-5 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">

          <h5 class="mb-3">üì¶ Order Summary</h5>

          <p class="mb-1">
            <strong>Status:</strong>
            <span class="badge bg-secondary">
              {{ order.status.replace("_", " ") }}
            </span>
          </p>

          <p class="mb-1">
            <strong>Total Amount:</strong>
            ‚Çπ{{ order.total_amount }}
          </p>

          <p class="mb-3">
            <strong>Placed On:</strong>
            {{ order.created_at.strftime("%d %b %Y, %I:%M %p") }}
          </p>

          <hr>

          <h6 class="mb-2">Items</h6>
          <ul class="list-unstyled small">
            {% for item in order.items %}
              <li class="d-flex justify-content-between">
                <span>
                  {{ item.product_name }} √ó {{ item.qty }}
                  {% if item.status == "CANCELLED" %}
                    <span class="text-danger">(Cancelled)</span>
                  {% endif %}
                </span>
                <span>‚Çπ{{ item.subtotal }}</span>
              </li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>

    <!-- RIGHT: CANCEL FORM (ENHANCED, NOT BROKEN) -->
    <div class="col-md-7">
      <div class="card shadow-sm border-danger">
        <div class="card-body">

          <h5 class="text-danger mb-3">
            ‚ö†Ô∏è Confirm Cancellation
          </h5>

          <div class="alert alert-warning small">
            ‚Ä¢ You can cancel one, multiple, or all items.<br>
            ‚Ä¢ This action cannot be undone.<br>
            ‚Ä¢ Cancelled items cannot be processed again.
          </div>

          <form method="POST">

            <!-- ITEM SELECTION -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                Select items to cancel <span class="text-danger">*</span>
              </label>

              {% for item in order.items %}
                {% if item.status != "CANCELLED" %}
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="item_ids"
                      value="{{ item.id }}"
                      id="item{{ item.id }}"
                    >
                    <label class="form-check-label" for="item{{ item.id }}">
                      {{ item.product_name }} √ó {{ item.qty }}
                      (‚Çπ{{ item.subtotal }})
                    </label>
                  </div>
                {% else %}
                  <div class="text-muted small mb-2">
                    {{ item.product_name }} ‚Äî ‚ùå Already cancelled
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            <!-- REASON -->
            <div class="mb-3">
              <label class="form-label fw-semibold">
                Reason for cancellation <span class="text-danger">*</span>
              </label>
              <textarea
                name="reason"
                class="form-control"
                rows="4"
                placeholder="Please tell us why you want to cancel the selected item(s)..."
                required></textarea>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="d-flex gap-2 mt-4">
              <button
                type="submit"
                class="btn btn-danger px-4"
                onclick="return confirm('Are you sure you want to cancel the selected item(s)?');">
                ‚ùå Cancel Selected Items
              </button>

              <a href="{{ url_for('main.orders') }}"
                 class="btn btn-outline-secondary">
                ‚Üê Back to Orders
              </a>
            </div>

          </form>

        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}
