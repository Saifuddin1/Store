{% extends "layout/customer_base.html" %}
{% block title %}Cancel Order #{{ order.id }}{% endblock %}

{% block content %}

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-9">

      <!-- PAGE HEADER -->
      <div class="mb-4">
        <h3 class="text-danger">‚ùå Cancel Order #{{ order.id }}</h3>
        <p class="text-muted mb-0">
          Please review the items carefully before cancelling.
        </p>
      </div>

      <div class="row">

        <!-- LEFT: ORDER SUMMARY -->
        <div class="col-md-5 mb-4">
          <div class="card shadow-sm order-summary-card">
            <div class="card-body">

              <h5 class="mb-3">üì¶ Order Summary</h5>

              <p class="mb-1">
                <strong>Status:</strong>
                <span class="badge bg-secondary">
                  {{ order.status.replace("_", " ") }}
                </span>
              </p>

              <p class="mb-1">
                <strong>Total Amount:</strong> ‚Çπ{{ order.total_amount }}
              </p>

              <p class="mb-3">
                <strong>Placed On:</strong>
                {{ order.created_at.strftime("%d %b %Y, %I:%M %p") }}
              </p>

              <hr>

              <h6 class="mb-2">Items</h6>
              <ul class="list-unstyled small mb-0">
                {% for item in order.items %}
                <li class="d-flex justify-content-between">
                  <span>
                    {{ item.product_name }} √ó {{ item.qty }}
                    {% if item.status == "CANCELLED" %}
                      <span class="text-danger">(Cancelled)</span>
                    {% endif %}
                  </span>
                  <span>‚Çπ{{ item.subtotal }}</span>
                </li>
                {% endfor %}
              </ul>

            </div>
          </div>
        </div>

        <!-- RIGHT: CANCEL FORM -->
        <div class="col-md-7">
          <div class="card shadow-sm border-danger cancel-card">
            <div class="card-body">

              <h5 class="text-danger mb-3">‚ö†Ô∏è Select Items to Cancel</h5>

              <div class="alert alert-warning small">
                ‚Ä¢ You can cancel one, multiple, or all items.<br>
                ‚Ä¢ This action cannot be undone.
              </div>

              <form method="POST">

                <!-- ITEM GRID -->
                <div class="cancel-items-grid mb-4">

                  {% for item in order.items %}
                  <label class="cancel-item-card {% if item.status == 'CANCELLED' %}disabled{% endif %}">

                    {% if item.status != "CANCELLED" %}
                      <input
                        type="checkbox"
                        name="item_ids"
                        value="{{ item.id }}"
                        class="item-checkbox">
                    {% endif %}

                    <!-- IMAGE -->
                    <div class="cancel-product-thumb">
                      {% if item.product and item.product.primary_image %}
                        <img src="{{ url_for('static', filename=item.product.primary_image) }}"
                             alt="{{ item.product_name }}"
                             loading="lazy">
                      {% else %}
                        <div class="no-image">No Image</div>
                      {% endif %}
                    </div>

                    <!-- INFO -->
                    <div class="item-content">
                      <div class="item-name text-truncate">
                        {{ item.product_name }}
                      </div>

                      <div class="item-meta">
                        Qty: {{ item.qty }}
                      </div>

                      <div class="item-price">
                        ‚Çπ{{ item.subtotal }}
                      </div>

                      {% if item.status == "CANCELLED" %}
                        <span class="badge bg-secondary mt-1">
                          Already Cancelled
                        </span>
                      {% endif %}
                    </div>

                  </label>
                  {% endfor %}

                </div>

                <!-- REASON -->
                <div class="mb-3">
                  <label class="form-label fw-semibold">
                    Reason for cancellation <span class="text-danger">*</span>
                  </label>
                  <textarea
                    name="reason"
                    class="form-control"
                    rows="4"
                    placeholder="Please tell us why you want to cancel the selected item(s)..."
                    required></textarea>
                </div>

                <!-- ACTIONS -->
                <div class="d-flex gap-2 mt-4">
                  <button type="submit"
                          class="btn btn-danger px-4"
                          onclick="return confirm('Are you sure you want to cancel the selected item(s)?');">
                    ‚ùå Cancel Selected Items
                  </button>

                  <a href="{{ url_for('main.orders') }}"
                     class="btn btn-outline-secondary">
                    ‚Üê Back to Orders
                  </a>
                </div>

              </form>

            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}
