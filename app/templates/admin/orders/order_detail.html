{% extends "layout/admin_base.html" %}

{% block title %}Order #{{ order.id }} | Admin{% endblock %}

{% block admin_content %}

<h3 class="mb-3">üì¶ Order #{{ order.id }}</h3>

<!-- ================= ORDER SUMMARY ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-body">

    <p>
      <strong>Status:</strong>
      <span class="badge bg-info">
        {{ order.status.replace("_", " ") }}
      </span>
    </p>

    <p>
      <strong>Customer:</strong> {{ order.user.email }} <br>
      <strong>Placed On:</strong>
      {{ order.created_at.strftime("%d %b %Y, %I:%M %p") }}
    </p>

    <p>
      <strong>Total Amount:</strong> ‚Çπ{{ order.total_amount }}
    </p>

  </div>
</div>

<!-- ================= ADMIN ITEM-LEVEL CANCEL ================= -->
{% if order.status in ["PLACED", "CONFIRMED", "PARTIALLY_CANCELLED"] %}
<div class="card shadow-sm mb-4">
  <div class="card-body">

    <h5 class="text-danger mb-2">‚ùå Cancel Items</h5>
    <p class="text-muted small">
      Select items to cancel. Shipped or delivered items cannot be cancelled.
    </p>

    <form method="POST"
          action="{{ url_for('admin.update_order_status', order_id=order.id) }}">

      <input type="hidden" name="status" value="CANCELLED">

      <!-- ITEM GRID (SELECTABLE) -->
      <div class="cancel-items-grid mb-4">

        {% for item in order.items %}
        <label class="cancel-item-card {% if item.status in ['CANCELLED','SHIPPED','DELIVERED'] %}disabled{% endif %}">

          {% if item.status not in ['CANCELLED','SHIPPED','DELIVERED'] %}
            <input
              type="checkbox"
              name="item_ids"
              value="{{ item.id }}"
              class="item-checkbox">
          {% endif %}

          <!-- IMAGE -->
          <div class="cancel-product-thumb">
            {% if item.product and item.product.primary_image %}
              <img src="{{ url_for('static', filename=item.product.primary_image) }}"
                   alt="{{ item.product_name }}"
                   loading="lazy">
            {% else %}
              <div class="no-image">No Image</div>
            {% endif %}
          </div>

          <!-- INFO -->
          <div class="item-content">
            <div class="item-name text-truncate">
              {{ item.product_name }}
            </div>

            <div class="item-meta">
              Qty: {{ item.qty }}
            </div>

            <div class="item-price">
              ‚Çπ{{ item.subtotal }}
            </div>

            {% if item.status == "CANCELLED" %}
              <span class="badge bg-secondary mt-1">
                Already Cancelled
              </span>
            {% endif %}
          </div>

        </label>
        {% endfor %}

      </div>

      <!-- REASON -->
      <div class="mb-3">
        <label class="form-label fw-semibold">
          Cancellation Reason <span class="text-danger">*</span>
        </label>
        <textarea
          name="remark"
          class="form-control"
          rows="3"
          required
          placeholder="Reason for cancelling selected item(s)"></textarea>
      </div>

      <button type="submit"
              class="btn btn-danger"
              onclick="return confirm('Are you sure you want to cancel the selected item(s)?');">
        ‚ùå Cancel Selected Items & Notify Customer
      </button>

    </form>

  </div>
</div>
{% endif %}

<!-- ================= STATUS HISTORY ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-body">

    <h5 class="mb-3">üïí Order Status History</h5>

    {% if order.status_history %}
      <ul class="list-group list-group-flush">
        {% for h in order.status_history|sort(attribute="changed_at") %}
          <li class="list-group-item">
            <strong>{{ h.old_status or "‚Äî" }} ‚Üí {{ h.new_status }}</strong><br>
            <small class="text-muted">
              {{ h.changed_at.strftime("%d %b %Y, %I:%M %p") }}
              ¬∑ {{ h.admin.email if h.admin else "System / Customer" }}
            </small>

            {% if h.remark %}
              <div class="text-muted mt-1">
                üìù {{ h.remark }}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No status changes recorded.</p>
    {% endif %}

  </div>
</div>

<a href="{{ url_for('admin.orders') }}"
   class="btn btn-outline-secondary">
  ‚Üê Back to Orders
</a>

{% endblock %}
