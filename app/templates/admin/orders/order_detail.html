{% extends "layout/admin_base.html" %}

{% block title %}Order #{{ order.id }} | Admin{% endblock %}

{% block admin_content %}

<h3 class="mb-3">üì¶ Order #{{ order.id }}</h3>

<!-- ================= ORDER SUMMARY ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-body">

    <p>
      <strong>Status:</strong>
      <span class="badge bg-info">
        {{ order.status.replace("_", " ") }}
      </span>
    </p>

    <p>
      <strong>Customer:</strong> {{ order.user.email }} <br>
      <strong>Placed On:</strong>
      {{ order.created_at.strftime("%d %b %Y, %I:%M %p") }}
    </p>

    <p>
      <strong>Total Amount:</strong> ‚Çπ{{ order.total_amount }}
    </p>

    <hr>

    <!-- ================= ITEMS ================= -->
    <h5>Items</h5>
    <ul class="list-unstyled">
      {% for item in order.items %}
        <li class="d-flex justify-content-between align-items-center mb-2">
          <div>
            {{ item.product_name }} √ó {{ item.qty }}

            {% if item.status == "CANCELLED" %}
              <span class="badge bg-danger ms-2">Cancelled</span>
            {% elif item.status == "SHIPPED" %}
              <span class="badge bg-info ms-2">Shipped</span>
            {% elif item.status == "DELIVERED" %}
              <span class="badge bg-success ms-2">Delivered</span>
            {% else %}
              <span class="badge bg-secondary ms-2">Active</span>
            {% endif %}
          </div>

          <span>‚Çπ{{ item.subtotal }}</span>
        </li>
      {% endfor %}
    </ul>

    <hr>

    <!-- ================= ADMIN ACTIONS ================= -->
    <h5 class="mt-4">‚öô Admin Actions</h5>

    {% if order.status == "PLACED" %}
      <form method="POST"
            action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
            class="mb-3">
        <input type="hidden" name="status" value="CONFIRMED">
        <button class="btn btn-primary">
          ‚úÖ Confirm Order
        </button>
      </form>
    {% endif %}

    {% if order.status in ["CONFIRMED", "PARTIALLY_CANCELLED"] %}
      <form method="POST"
            action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
            class="mb-3">
        <input type="hidden" name="status" value="PACKED">
        <button class="btn btn-warning">
          üì¶ Mark as Packed
        </button>
      </form>
    {% endif %}

    {% if order.status == "PACKED" %}
      <form method="POST"
            action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
            class="mb-3">
        <input type="hidden" name="status" value="SHIPPED">
        <button class="btn btn-info">
          üöö Dispatch Order
        </button>
      </form>
    {% endif %}

    {% if order.status == "SHIPPED" %}
      <form method="POST"
            action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
            class="mb-3">
        <input type="hidden" name="status" value="DELIVERED">
        <button class="btn btn-success">
          üì¨ Mark as Delivered
        </button>
      </form>
    {% endif %}

    <!-- ================= ADMIN ITEM-LEVEL CANCEL ================= -->
    {% if order.status in ["PLACED", "CONFIRMED", "PARTIALLY_CANCELLED"] %}
      <hr>
      <h5 class="mt-4 text-danger">‚ùå Cancel Items</h5>
      <p class="text-muted small">
        Select specific items to cancel. Shipped or delivered items cannot be cancelled.
      </p>

      <form method="POST"
            action="{{ url_for('admin.update_order_status', order_id=order.id) }}"
            class="mt-3">

        <input type="hidden" name="status" value="CANCELLED">

        <!-- ITEM CHECKBOXES -->
        <div class="mb-3">
          {% for item in order.items %}
            {% if item.status not in ["CANCELLED", "SHIPPED", "DELIVERED"] %}
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="item_ids"
                  value="{{ item.id }}"
                  id="admin_item_{{ item.id }}"
                >
                <label class="form-check-label" for="admin_item_{{ item.id }}">
                  {{ item.product_name }} √ó {{ item.qty }}
                  (‚Çπ{{ item.subtotal }})
                </label>
              </div>
            {% else %}
              <div class="text-muted small mb-2">
                {{ item.product_name }} ‚Äî {{ item.status.replace("_"," ").title() }}
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- REASON -->
        <div class="mb-3">
          <label class="form-label">
            Cancellation Reason
          </label>
          <textarea
            name="remark"
            class="form-control"
            rows="3"
            placeholder="Reason for cancelling selected item(s)"
            required></textarea>
        </div>

        <button type="submit" class="btn btn-danger">
          Cancel Selected Items & Notify Customer
        </button>
      </form>
    {% endif %}

  </div>
</div>

<!-- ================= STATUS HISTORY ================= -->
<div class="card shadow-sm">
  <div class="card-body">

    <h5 class="mb-3">üïí Order Status History</h5>

    {% if order.status_history %}
      <ul class="list-group list-group-flush">
        {% for h in order.status_history|sort(attribute="changed_at") %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between">
              <div>
                <strong>
                  {{ h.old_status or "‚Äî" }}
                  ‚Üí
                  {{ h.new_status }}
                </strong>
                <br>
                <small class="text-muted">
                  Changed by:
                  {{ h.admin.email if h.admin else "System / Customer" }}
                </small>

                {% if h.remark %}
                  <div class="mt-1 text-muted">
                    üìù {{ h.remark }}
                  </div>
                {% endif %}
              </div>

              <small class="text-muted">
                {{ h.changed_at.strftime("%d %b %Y, %I:%M %p") }}
              </small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">
        No status changes recorded yet.
      </p>
    {% endif %}

  </div>
</div>

<a href="{{ url_for('admin.orders') }}"
   class="btn btn-outline-secondary mt-3">
  ‚Üê Back to Orders
</a>

{% endblock %}
