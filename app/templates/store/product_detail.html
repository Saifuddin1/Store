{% extends "layout/customer_base.html" %}

{% block title %}{{ product.name }} | My Store{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav class="mb-3 small">
  <a href="/" class="text-decoration-none">Home</a> /
  <a href="{{ url_for('main.products') }}" class="text-decoration-none">Products</a> /
  <span class="text-muted">{{ product.name }}</span>
</nav>

<div class="row g-4">

  <!-- LEFT: PRODUCT GALLERY -->
  <div class="col-md-5">

    <div class="card shadow-sm mb-3 product-zoom-container">
      {% if primary_image %}
        <img
          id="main-product-image"
          src="{{ url_for('static', filename=primary_image.image_path) }}"
          class="img-fluid rounded product-zoom-image"
          alt="{{ product.name }}">
      {% else %}
        <div class="bg-light d-flex align-items-center justify-content-center"
             style="height:420px;">
          <span class="text-muted">No Image Available</span>
        </div>
      {% endif %}
    </div>

    {% if images|length > 1 %}
    <div class="d-flex flex-wrap">
      {% for img in images %}
        <img
          src="{{ url_for('static', filename=img.image_path) }}"
          class="me-2 mb-2 border rounded product-thumb"
          onclick="changeMainImage('{{ url_for('static', filename=img.image_path) }}', this)">
      {% endfor %}
    </div>
    {% endif %}

  </div>

  <!-- RIGHT: PRODUCT DETAILS -->
  <div class="col-md-7">

    <h2 class="mb-2">{{ product.name }}</h2>
    {% if avg_rating %}
      <div class="mb-2">

        <span class="text-warning fs-5">
          {% for i in range(avg_rating|int) %}
            ‚≠ê
          {% endfor %}
          {% for i in range(5 - (avg_rating|int)) %}
            ‚òÜ
          {% endfor %}
        </span>

        <span class="text-muted ms-2">
          {{ avg_rating }} / 5 ({{ reviews|length }} reviews)
        </span>

      </div>
    {% endif %}


    <!-- PRICE -->
    <div class="mb-2">
      {% if product.final_price < product.price %}
        <span class="fs-3 fw-bold text-success">
          ‚Çπ{{ product.final_price }}
        </span>
        <del class="text-muted ms-2">‚Çπ{{ product.price }}</del>
        <span class="badge bg-success ms-2">
          Save ‚Çπ{{ (product.price - product.final_price)|round(0, 'floor')|int }}
        </span>
      {% else %}
        <span class="fs-3 fw-bold">‚Çπ{{ product.price }}</span>
      {% endif %}
    </div>

    <!-- STOCK -->
    {% if product.stock_quantity > 0 %}
      <span class="badge bg-success mb-3">In Stock</span>
    {% else %}
      <span class="badge bg-danger mb-3">Out of Stock</span>
    {% endif %}

    <!-- TRUST INFO -->
    <ul class="list-unstyled text-muted small mb-3">
      <li>‚úî Cash on Delivery Available</li>
      <li>‚úî 7-Day Easy Returns</li>
      <li>‚úî Secure Checkout</li>
    </ul>

    <!-- ADD TO CART -->
    {% if product.stock_quantity > 0 %}
    <form method="POST"
          action="{{ url_for('main.cart_add', product_id=product.id) }}"
          class="mb-4">

      <!-- QTY SELECTOR -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Quantity</label>

        <div class="qty-box">

          <button type="button"
                  class="qty-btn"
                  onclick="changeQty(-1)">
            -
          </button>

          <input type="number"
                 id="qty-input"
                 name="qty"
                 class="qty-input"
                 value="1"
                 min="1"
                 max="{{ product.stock_quantity }}"
                 readonly>

          <button type="button"
                  class="qty-btn"
                  onclick="changeQty(1)">
            +
          </button>

        </div>

        <small class="text-muted">
          Available stock: {{ product.stock_quantity }}
        </small>
      </div>

      <button type="submit"
              class="btn btn-primary btn-lg w-100">
        üõí Add to Cart
      </button>

    </form>

{% else %}

  <div class="alert alert-danger mb-3">
    üö´ This product is currently out of stock.
  </div>

  <!-- üîî WhatsApp Notify
  <a href="https://wa.me/919581170036?text={{ 
      ('Hi, I want to be notified when this product is back in stock:%0A%0A'
      ~ product.name ~ '%0A'
      ~ 'Price: ‚Çπ' ~ product.final_price
      ) | urlencode }}"
     target="_blank"
     class="btn btn-success btn-lg w-100 mb-2">

    üì≤ Notify Me on WhatsApp
  </a> -->

  {% if current_user.is_authenticated %}
    <form method="POST"
          action="{{ url_for('main.notify_me', product_id=product.id) }}">
      <button type="submit"
              class="btn btn-outline-secondary btn-lg w-100">
        üîî Email Me When Available
      </button>
    </form>
  {% endif %}

{% endif %}




    <!-- TABS -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#desc">
          Description
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#delivery">
          Delivery & Returns
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="desc">
        <p class="text-muted mt-3">
          {{ product.description or "No description available." }}
        </p>
      </div>
      <div class="tab-pane fade" id="delivery">
        <p class="text-muted mt-3">
          üöö Delivered in 3-5 business days.<br>
          üîÅ 7-day replacement or refund available.
        </p>
      </div>
    </div>
<!-- ================= REVIEWS ================= -->
<div class="mt-5">

  <h4 class="mb-3">Customer Reviews</h4>

  {% for r in reviews %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong>
            {{ reviewer_names.get(r.user_id, "Customer") }}
          </strong>
          <span class="badge bg-success ms-2">Verified Buyer</span>

          <small class="text-muted">
            {{ r.created_at.strftime("%d %b %Y") }}
          </small>
        </div>

        <div class="mb-1">
          {% for i in range(r.rating) %}‚≠ê{% endfor %}
          {% for i in range(5 - r.rating) %}‚òÜ{% endfor %}
        </div>

        {% if r.title %}
          <div class="fw-semibold">{{ r.title }}</div>
        {% endif %}

        <p class="mb-0 text-muted">
          {{ r.comment }}
        </p>

      </div>
    </div>
  {% endfor %}

</div>
<!-- =============== END REVIEWS ================= -->

  </div>

</div>

<!-- ================= SCRIPTS ================= -->
<script>
function changeMainImage(imageUrl, thumb) {
  const mainImg = document.getElementById("main-product-image");
  if (!mainImg) return;

  mainImg.src = imageUrl;

  document.querySelectorAll(".product-thumb").forEach(img => {
    img.classList.remove("border-primary");
  });
  thumb.classList.add("border-primary");
}

function changeQty(delta) {
  const input = document.getElementById("qty-input");
  const max = parseInt(input.max);
  let value = parseInt(input.value);

  value += delta;

  if (value < 1) value = 1;
  if (value > max) value = max;

  input.value = value;
}

const zoomContainer = document.querySelector(".product-zoom-container");
const zoomImage = document.querySelector(".product-zoom-image");

if (zoomContainer && zoomImage) {
  zoomContainer.addEventListener("mousemove", function (e) {
    const rect = zoomContainer.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    zoomImage.style.transformOrigin = `${x}% ${y}%`;
    zoomImage.style.transform = "scale(2)";
  });

  zoomContainer.addEventListener("mouseleave", function () {
    zoomImage.style.transform = "scale(1)";
    zoomImage.style.transformOrigin = "center center";
  });
}
</script>

<!-- ================= STYLES ================= -->
<style>
.product-thumb {
  width: 75px;
  height: 75px;
  object-fit: cover;
  cursor: pointer;
}

.product-thumb:hover,
.product-thumb.border-primary {
  border: 2px solid #0d6efd !important;
}

.product-zoom-container {
  overflow: hidden;
  cursor: zoom-in;
}

.product-zoom-image {
  transition: transform 0.25s ease;
  width: 100%;
  height: 420px;
  object-fit: cover;
}

.qty-box {
  display: inline-flex;
  align-items: center;
  border: 1px solid #ced4da;
  border-radius: 8px;
  overflow: hidden;
}

.qty-btn {
  background: #f8f9fa;
  border: none;
  padding: 8px 16px;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
}

.qty-btn:hover {
  background: #e9ecef;
}

.qty-input {
  width: 60px;
  text-align: center;
  border: none;
  outline: none;
  font-size: 16px;
  font-weight: 500;
  background: white;
}

@media (max-width: 768px) {
  .product-zoom-container {
    cursor: default;
  }
  .product-zoom-image {
    transform: none !important;
  }
}
</style>

{% endblock %}
