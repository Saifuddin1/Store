{% extends "layout/customer_base.html" %}

{% block title %}Checkout | {{ site_settings.site_name }}{% endblock %}

{% block content %}

<div class="container">

  <!-- ================= HEADER ================= -->
  <div class="mb-4">
    <h2 class="fw-bold mb-1">Checkout</h2>
    <p class="text-muted mb-0">
      Confirm address and review your order
    </p>
  </div>

  <a href="{{ url_for('main.cart_view') }}"
     class="btn btn-link p-0 mb-3">
    ‚Üê Back to Cart
  </a>

  <form method="POST" action="{{ url_for('main.place_order') }}">

    <div class="row g-4">

      <!-- ================= LEFT: ADDRESS ================= -->
      <div class="col-lg-7">

        <div class="card shadow-sm">
          <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-semibold mb-0">Delivery Address</h5>

              <a href="{{ url_for('main.add_address') }}"
                 class="btn btn-sm btn-outline-primary">
                + Add Address
              </a>
            </div>

            {% if addresses %}
              {% for addr in addresses %}
              <label class="border rounded p-3 mb-3 d-block"
                     style="cursor:pointer;">

                <div class="d-flex justify-content-between align-items-start">

                  <!-- ADDRESS -->
                  <div>
                    <strong>{{ addr.full_name }}</strong><br>
                    {{ addr.address_line1 }}{% if addr.address_line2 %}, {{ addr.address_line2 }}{% endif %}<br>
                    {{ addr.city }}, {{ addr.state }} ‚Äì {{ addr.postal_code }}<br>
                    <small class="text-muted">Phone: {{ addr.phone }}</small>
                  </div>

                  <!-- RADIO -->
                  <div class="ms-3 pt-1">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="address_id"
                      value="{{ addr.id }}"
                      {% if addr.is_default or loop.first %}checked{% endif %}
                      required
                    >
                  </div>

                </div>
              </label>
              {% endfor %}
            {% else %}
              <div class="alert alert-warning mb-0">
                No delivery address found.
                <a href="{{ url_for('main.add_address') }}">Add Address</a>
              </div>
            {% endif %}

          </div>
        </div>

      </div>

      <!-- ================= RIGHT: ORDER SUMMARY ================= -->
      <div class="col-lg-5">

        <div class="card shadow-sm border border-dark">
          <div class="card-body">

            <h5 class="fw-bold mb-3">Order Summary</h5>

            <!-- ITEMS -->
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>Product</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr>
                  <td>{{ item.name }}</td>
                  <td class="text-center">{{ item.qty }}</td>
                  <td class="text-end">
                    ‚Çπ{{ item.final_price * item.qty }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <hr>

            <!-- PRICE BREAKUP -->
            <div class="d-flex justify-content-between mb-2">
              <span>Items ({{ totals.total_qty }})</span>
              <span>‚Çπ{{ totals.subtotal }}</span>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <span>Delivery Fee</span>
              {% if totals.delivery_fee == 0 %}
                <span class="text-success fw-semibold">FREE</span>
              {% else %}
                <span>‚Çπ{{ totals.delivery_fee }}</span>
              {% endif %}
            </div>

            <hr>

            <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
              <span>Total Amount</span>
              <span>‚Çπ{{ totals.grand_total }}</span>
            </div>

            {% if totals.delivery_fee > 0 %}
              <div class="alert alert-info small mb-3">
                Add items worth ‚Çπ{{ 500 - totals.subtotal }} more for FREE delivery üöö
              </div>
            {% endif %}

            {% if addresses %}
              <div class="d-grid">
                <button type="submit"
                        class="btn btn-primary btn-lg">
                  Place Order (Cash on Delivery)
                </button>
              </div>
            {% endif %}

          </div>
        </div>

      </div>

    </div>

  </form>

</div>
{% endblock %}
