{% extends "layout/customer_base.html" %}

{% block title %}My Orders{% endblock %}

{% block content %}

{% set STATUS_COLORS = {
  "PLACED": "secondary",
  "CONFIRMED": "primary",
  "PACKED": "info",
  "SHIPPED": "warning",
  "OUT_FOR_DELIVERY": "dark",
  "DELIVERED": "success",
  "CANCELLED": "danger",
  "RETURNED": "danger"
} %}

<h2 class="mb-2">My Orders</h2>

{% if orders %}
{% for order in orders %}

<div class="card shadow-sm border border-dark border-2 mb-2">
  <div class="card-body p-2">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div class="lh-sm">
        <strong class="small">Order #{{ order.id }}</strong><br>
        <small class="text-muted">
          {{ order.created_at.strftime("%d %b %Y, %I:%M %p") }}
        </small>
      </div>

      <span class="badge bg-{{ STATUS_COLORS.get(order.status, 'secondary') }} small">
        {{ order.status.replace("_", " ") }}
      </span>
    </div>

    <hr class="my-1">

    <!-- ITEMS -->
    <ul class="list-unstyled small mb-1">
      {% for item in order.items %}
      <li class="mb-1">

        <div class="d-flex justify-content-between align-items-start lh-sm">
          <div>
            <strong>{{ item.product_name }}</strong><br>
            <small class="text-muted">Qty: {{ item.qty }}</small>
          </div>

          <div class="text-end">
            <span class="fw-semibold">₹{{ item.subtotal }}</span><br>

            {% if order.status == "DELIVERED" %}
            <button class="btn btn-sm btn-outline-primary py-0 px-2 mt-1"
                    data-bs-toggle="collapse"
                    data-bs-target="#reviewForm{{ order.id }}{{ item.id }}">
              ⭐ Review
            </button>
            {% endif %}
          </div>
        </div>

        <!-- REVIEW FORM -->
        {% if order.status == "DELIVERED" %}
        <div class="collapse mt-1"
             id="reviewForm{{ order.id }}{{ item.id }}">

          <form method="POST"
                action="{{ url_for('main.submit_review_from_order', product_id=item.product_id) }}"
                class="card card-body bg-light p-2">

            <div class="mb-1">
              <select name="rating"
                      class="form-select form-select-sm"
                      required>
                <option value="">Rating</option>
                <option value="5">⭐⭐⭐⭐⭐</option>
                <option value="4">⭐⭐⭐⭐</option>
                <option value="3">⭐⭐⭐</option>
                <option value="2">⭐⭐</option>
                <option value="1">⭐</option>
              </select>
            </div>

            <div class="mb-1">
              <input type="text"
                     name="title"
                     class="form-control form-control-sm"
                     placeholder="Title">
            </div>

            <div class="mb-1">
              <textarea name="comment"
                        rows="2"
                        class="form-control form-control-sm"
                        required
                        placeholder="Review"></textarea>
            </div>

            <div class="text-end">
              <button type="submit"
                      class="btn btn-sm btn-primary py-0 px-2">
                Submit
              </button>
            </div>

          </form>
        </div>
        {% endif %}

      </li>
      {% endfor %}
    </ul>

    <!-- TOTAL -->
    <p class="fw-bold small mb-1">
      Total: ₹{{ order.total_amount }}
    </p>

    <!-- TRACKING -->
    {% if order.status in ["DISPATCHED", "SHIPPED", "OUT_FOR_DELIVERY", "DELIVERED"] %}
    <div class="alert alert-info small py-1 px-2 mb-1">
      <strong>Courier:</strong> {{ order.courier_name or "—" }} |
      <strong>Tracking:</strong> {{ order.tracking_number or "—" }}
    </div>
    {% endif %}

    <!-- TIMELINE -->
    <div class="order-timeline mt-1">

      {% set steps = ["PLACED", "CONFIRMED", "SHIPPED", "DELIVERED"] %}
      {% set current_index = steps.index(order.status) if order.status in steps else -1 %}

      {% for step in steps %}
      {% set step_index = loop.index0 %}
      <div class="order-step
           {% if step_index < current_index %}completed{% endif %}
           {% if step_index == current_index %}active{% endif %}">
        <div class="dot"></div>
        <span>{{ step.title() }}</span>
      </div>
      {% endfor %}

    </div>

    <!-- ACTION -->
    <div class="text-end mt-1">
      {% if order.status in ["PLACED", "CONFIRMED"] %}
      <a href="{{ url_for('main.cancel_order', order_id=order.id) }}"
         class="btn btn-sm btn-outline-danger py-0 px-2">
        Cancel
      </a>
      {% endif %}
    </div>

  </div>
</div>

{% endfor %}
{% else %}
<div class="alert alert-info py-2 px-3">
  You have not placed any orders yet.
</div>
{% endif %}

<!-- COMPACT TIMELINE -->
<style>
.order-timeline {
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
}
.order-step {
  flex: 1;
  text-align: center;
  font-size: 11px;
  position: relative;
}
.order-step::after {
  content: "";
  position: absolute;
  top: 7px;
  right: -50%;
  width: 100%;
  height: 2px;
  background: #dee2e6;
}
.order-step:last-child::after {
  display: none;
}
.order-step .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin: 0 auto 2px;
  background: #dee2e6;
}
.order-step.completed .dot,
.order-step.completed::after {
  background: #198754;
}
.order-step.active .dot {
  background: #0d6efd;
}
</style>

{% endblock %}
